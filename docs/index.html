<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">

    <title>Suivi Séance Musculation - Enhanced v2</title>
    
    <style>
        :root {
            --bg-grad-start: #667eea;
            --bg-grad-end: #764ba2;
            --container-bg: rgba(255, 255, 255, 0.95);
            --text-color: #333;
            --header-color: #4a5568;
            --border-color: #e2e8f0;
            --row-bg-even: rgba(248, 250, 252, 0.8);
            --input-bg: white;
            --primary-grad-start: #667eea;
            --primary-grad-end: #764ba2;
            --success-grad-start: #48bb78;
            --success-grad-end: #38a169;
            --warning-grad-start: #ed8936;
            --warning-grad-end: #dd6b20;
            --danger-grad-start: #f56565;
            --danger-grad-end: #e53e3e;
            --info-grad-start: #4299e1;
            --info-grad-end: #3182ce;
            --text-on-color: white;
        }

        body.dark-mode {
            --bg-grad-start: #1a202c;
            --bg-grad-end: #2d3748;
            --container-bg: rgba(45, 55, 72, 0.95);
            --text-color: #e2e8f0;
            --header-color: #a0aec0;
            --border-color: #4a5568;
            --row-bg-even: rgba(26, 32, 44, 0.8);
            --input-bg: #2d3748;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 1rem;
            background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
        }
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: background 0.3s;
        }
        h2 {
            text-align: center;
            color: var(--header-color);
            margin-bottom: 2rem;
            font-size: 2rem;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }
        select, input[type="number"], input[type="text"] {
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            background: var(--input-bg);
            margin-bottom: 2rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px; /* Adjusted for new column */
        }
        th, td {
            padding: 1rem 0.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background: linear-gradient(135deg, var(--primary-grad-start), var(--primary-grad-end));
            color: var(--text-on-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .fixed-col {
            position: sticky;
            left: 0;
            background: inherit;
            min-width: 200px;
            text-align: left;
            padding-left: 1rem;
            font-weight: 600;
        }
        .exercise-row:nth-child(even) { background: var(--row-bg-even); }
        .serie-input input {
            width: 60px;
            padding: 0.4rem;
            text-align: center;
        }
        .serie-input input.completed {
            background: linear-gradient(135deg, var(--success-grad-start), var(--success-grad-end));
            color: var(--text-on-color);
            border-color: var(--success-grad-end);
        }
        .tonnage-high, .onerm-high {
            background: linear-gradient(135deg, var(--success-grad-start), var(--success-grad-end));
            color: var(--text-on-color);
            border-radius: 6px;
            padding: 0.5rem;
            font-weight: 600;
        }
        .timer-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .timer-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .timer-btn[data-timer-action="start"] { background: linear-gradient(135deg, var(--success-grad-start), var(--success-grad-end)); color: var(--text-on-color); }
        .timer-btn[data-timer-action="stop"] { background: linear-gradient(135deg, var(--danger-grad-start), var(--danger-grad-end)); color: var(--text-on-color); }
        .timer-btn[data-timer-action="reset"] { background: linear-gradient(135deg, var(--warning-grad-start), var(--warning-grad-end)); color: var(--text-on-color); }
        .timer-display.timer-active { color: var(--success-grad-start); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .summary-card { padding: 1.5rem; border-radius: 15px; text-align: center; background: rgba(255, 255, 255, 0.05); }
        .summary-card .value { font-size: 2rem; font-weight: bold; color: var(--primary-grad-start); }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 2rem; }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--text-on-color); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-grad-start), var(--primary-grad-end)); }
        .btn-secondary { background: linear-gradient(135deg, var(--warning-grad-start), var(--warning-grad-end)); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-grad-start), var(--danger-grad-end)); }
        .btn-success { background: linear-gradient(135deg, var(--success-grad-start), var(--success-grad-end)); }
        .notification { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 10px; color: var(--text-on-color); z-index: 1001; transform: translateX(400px); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, var(--success-grad-start), var(--success-grad-end)); }
        .notification.error { background: linear-gradient(135deg, var(--danger-grad-start), var(--danger-grad-end)); }
        .notification.info { background: linear-gradient(135deg, var(--info-grad-start), var(--info-grad-end)); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: var(--container-bg); padding: 2rem; border-radius: 15px; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: var(--border-color); color: var(--text-color); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.2rem; cursor: pointer; }
        #historyList { display: flex; flex-direction: column; gap: 1rem; }
        .history-item { border: 1px solid var(--border-color); border-radius: 10px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .history-details { display: none; width: 100%; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .history-details.visible { display: block; }
        .progress-bar { width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; margin: 1rem 0; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, var(--success-grad-start), var(--success-grad-end)); border-radius: 4px; transition: width 0.5s ease; }
        .hidden { display: none !important; }
        .theme-switcher { position: absolute; top: 1rem; right: 1rem; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="theme-switcher">
            <button id="themeToggleBtn" class="btn btn-primary" aria-label="Switch Theme">🌙</button>
        </div>
        <h2>💪 Suivi Séance Musculation</h2>
        
        <div class="controls">
          <label for="sessionSelect"><strong>Séance:</strong></label>
          <select id="sessionSelect">
            <option value="0">PUSH (Poitrine/Épaules/Triceps)</option>
            <option value="1">PULL (Dos/Biceps)</option>
            <option value="2">LEG (Jambes)</option>
            <option value="3">Épaules/Bras</option>
            <option value="4">Dos/Pec</option>
          </select>
          <input type="text" id="customExercise" placeholder="Ajouter un exercice">
          <button class="btn btn-success" id="addExerciseBtn" aria-label="Add Exercise">+</button>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="table-container">
          <table id="workoutTable">
            <thead>
              <tr>
                <th>Exercice</th>
                <th colspan="5">Séries (Reps / Poids kg)</th>
                <th>Tonnage</th>
                <th>1RM Max (kg)</th>
                <th>Repos</th>
                <th>Minuteur</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        
        <div class="summary-section">
            <div class="summary-card">
                <h3>🏋️ Tonnage Total</h3>
                <div class="value" id="totalTonnage">0</div>
            </div>
            <div class="summary-card">
                <h3>📊 Semaine Précédente</h3>
                <input type="number" id="previousWeek" placeholder="Tonnage Préc.">
            </div>
            <div class="summary-card">
                <h3>📈 Progression</h3>
                <div class="value" id="delta">0</div>
            </div>
            <div class="summary-card">
                <h3>⏱️ Temps Total</h3>
                <div class="value" id="totalTime">00:00:00</div>
            </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-danger" id="finishSessionBtn" aria-label="Finish and Save Session">✔️ Terminer & Sauvegarder</button>
          <button class="btn btn-primary" id="viewHistoryBtn" aria-label="View History">📖 Historique</button>
          <button class="btn btn-secondary" id="exportBtn" aria-label="Export CSV">📊 Exporter CSV</button>
          <button class="btn btn-success" id="importBtn" aria-label="Import Data">📥 Importer</button>
          <button class="btn btn-danger" id="resetSessionBtn" aria-label="Reset Session">🔄 Réinitialiser</button>
          <input type="file" id="importFile" class="hidden" accept=".json,.csv">
        </div>
    </div>
    
    <div id="notification-container"></div>
    
    <div id="historyModal" class="modal-overlay hidden">
      <div class="modal-content">
          <button id="closeHistoryModal" class="modal-close-btn" aria-label="Close History Modal">&times;</button>
          <h2>Historique des Séances</h2>
          <div id="historyList"></div>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const dom = {
            sessionSelect: document.getElementById('sessionSelect'),
            tbody: document.getElementById('tbody'),
            totalTonnageEl: document.getElementById('totalTonnage'),
            previousWeekInput: document.getElementById('previousWeek'),
            deltaEl: document.getElementById('delta'),
            totalTimeEl: document.getElementById('totalTime'),
            progressFill: document.getElementById('progressFill'),
            historyModal: document.getElementById('historyModal'),
            notificationContainer: document.getElementById('notification-container'),
            customExerciseInput: document.getElementById('customExercise'),
            historyList: document.getElementById('historyList'),
            importFileInput: document.getElementById('importFile'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            body: document.body
        };
        let state = {
            sessions: [],
            currentSessionIndex: 0,
            timers: {},
            workoutStartTime: null,
            totalWorkoutTimeInterval: null,
        };
        const defaultSessions = [
            [ // PUSH
                { name: "DC barre lourd", rest: "2 min" }, { name: "DC barre léger", rest: "2 min" }, { name: "Incliné haltères", rest: "1 min" }, { name: "Écarté vis à vis", rest: "1 min" }, { name: "Dips machine", rest: "1 min" }, { name: "Élévation latérale machine debout", rest: "1 min" }, { name: "Extension triceps poulie", rest: "1 min" }
            ],
            [ // PULL
                { name: "Traction", rest: "2 min" }, { name: "Pull poulie", rest: "1 min" }, { name: "Tirage uni poulie haute sur banc", rest: "1 min" }, { name: "Rowing T bar", rest: "1 min" }, { name: "Machine Row", rest: "1 min" }, { name: "Machine Row uni", rest: "1 min" }, { name: "Face pull", rest: "1 min" }, { name: "Oiseaux machine", rest: "1 min" }, { name: "Curl marteau simultané", rest: "1 min" }, { name: "Bayesian curl", rest: "1 min" }
            ],
            [ // LEG
                { name: "Leg extension drop", rest: "1 min" }, { name: "Presse horizontal", rest: "2 min" }, { name: "Squat guidé léger", rest: "1 min" }, { name: "Fente marché", rest: "2 min" }, { name: "Leg Curl assis", rest: "1 min" }, { name: "SDT jambes tendues smith", rest: "1 min" }
            ],
            [ // Épaules/Bras
                { name: "Militaire haltères pyramide montante", rest: "3 min" }, { name: "Élévation latérale", rest: "1 min" }, { name: "Élévation latérale supination", rest: "1 min" }, { name: "Face pull", rest: "1 min" }, { name: "Extension triceps", rest: "1 min" }, { name: "Curl poulie basse", rest: "1 min" }, { name: "Magic triceps", rest: "1 min" }, { name: "Curl pupitre", rest: "1 min" }, { name: "Dips", rest: "1 min" }, { name: "Curl haltères incliné", rest: "1 min" }, { name: "Cross Cable Triceps", rest: "1 min" }, { name: "Curl concentré haltère", rest: "1 min" }
            ],
            [ // Dos/Pec
                 { name: "Tirage horizontal", rest: "1 min" }, { name: "Rowing barre buste penché pronation", rest: "1 min" }, { name: "Tirage poulie basse avec corde", rest: "1 min" }, { name: "Incliné guidé", rest: "2 min" }, { name: "Écarté couché", rest: "1 min" }, { name: "Vis à vis sur banc incliné", rest: "1 min" }, { name: "Circuit abdos", rest: "1 min" }
            ]
        ];
        /**
         * Creates and populates the main workout table based on the current session.
         */
        function createTable() {
            dom.tbody.innerHTML = "";
            const exercises = state.sessions[state.currentSessionIndex] || [];
            
            exercises.forEach((ex, idx) => {
                const tr = document.createElement("tr");
                tr.className = "exercise-row";
                tr.dataset.exerciseIndex = idx;

                let seriesHtml = "";
                for(let i = 0; i < 5; i++) {
                    seriesHtml += `<td><div class="serie-input">
                        <input type="number" min="0" step="1" data-ex="${idx}" data-serie="${i}" class="reps" placeholder="Reps" aria-label="Reps for exercise ${idx+1} set ${i+1}">
                        <input type="number" min="0" step="0.5" data-ex="${idx}" data-serie="${i}" class="weight" placeholder="kg" aria-label="Weight for exercise ${idx+1} set ${i+1}">
                    </div></td>`;
                }
                
                tr.innerHTML = `
                    <td class="fixed-col">${ex.name}</td>
                    ${seriesHtml}
                    <td id="tonnage-${idx}">0</td>
                    <td id="onerm-${idx}">0</td>
                    <td><strong>${ex.rest}</strong></td>
                    <td>
                        <div class="timer-container">
                            <div class="timer-display" id="timer-${idx}">0:00</div>
                            <button class="timer-btn" data-timer-action="start" aria-label="Start Timer">▶</button>
                            <button class="timer-btn hidden" data-timer-action="stop" aria-label="Stop Timer">■</button>
                            <button class="timer-btn" data-timer-action="reset" aria-label="Reset Timer">⟲</button>
                        </div>
                    </td>
                    <td><button class="btn-danger" data-action="remove" aria-label="Remove Exercise">🗑️</button></td>`;
                dom.tbody.appendChild(tr);
            });
            loadCurrentState();
        }

        /**
         * Calculates the estimated 1 Rep Max using the mean of Brzycki and Mayhew et al. formulas.
         * @param {number} weight The weight lifted.
         * @param {number} reps The number of repetitions.
         * @returns {number} The estimated 1RM.
         */
        function calculate1RM(weight, reps) {
            if (reps === 0 || weight === 0) return 0;

            // Brzycki formula
            const brzycki1RM = weight / (1.0278 - (0.0278 * reps));

            // Mayhew et al. formula
            const mayhew1RM = (100 * weight) / (52.2 + (41.9 * Math.exp(-0.055 * reps)));

            // Return the mean of the two formulas
            return (brzycki1RM + mayhew1RM) / 2;
        }

        /**
         * Updates all calculations: tonnage, 1RM, progression delta, and progress bar.
         */
        function updateAllTotals() {
            let totalTonnage = 0;
            let completedSeries = 0;
            let totalSeries = (state.sessions[state.currentSessionIndex]?.length || 0) * 5;
            (state.sessions[state.currentSessionIndex] || []).forEach((_, idx) => {
                let tonnage = 0;
                let max1RM = 0;
                for(let i = 0; i < 5; i++) {
                    const repsInput = dom.tbody.querySelector(`.reps[data-ex='${idx}'][data-serie='${i}']`);
                    const weightInput = dom.tbody.querySelector(`.weight[data-ex='${idx}'][data-serie='${i}']`);
                    const reps = +repsInput?.value || 0;
                    const weight = +weightInput?.value || 0;
                    
                    if (reps > 0 && weight > 0) {
                        const currentTonnage = reps * weight;
                        tonnage += currentTonnage;

                        const current1RM = calculate1RM(weight, reps);
                        if (current1RM > max1RM) {
                            max1RM = current1RM;
                        }

                        repsInput.classList.add('completed');
                        weightInput.classList.add('completed');
                        completedSeries++;
                    } else {
                        repsInput?.classList.remove('completed');
                        weightInput?.classList.remove('completed');
                    }
                }
  
                const tonnageEl = dom.tbody.querySelector(`#tonnage-${idx}`);
                if(tonnageEl) {
                    tonnageEl.textContent = tonnage.toFixed(0);
                    tonnageEl.classList.toggle('tonnage-high', tonnage > 0);
                }

                const oneRmEl = dom.tbody.querySelector(`#onerm-${idx}`);
                if (oneRmEl) {
                    oneRmEl.textContent = max1RM > 0 ? max1RM.toFixed(1) : '0';
                    oneRmEl.classList.toggle('onerm-high', max1RM > 0);
                }

                totalTonnage += tonnage;
            });
            
            dom.totalTonnageEl.textContent = totalTonnage.toFixed(0);
            
            const previous = +dom.previousWeekInput.value || 0;
            const delta = totalTonnage - previous;
            dom.deltaEl.textContent = delta.toFixed(0);
            dom.deltaEl.style.color = delta > 0 ? 'var(--success-grad-start)' : delta < 0 ? 'var(--danger-grad-start)' : 'inherit';
            dom.progressFill.style.width = `${totalSeries > 0 ? (completedSeries / totalSeries) * 100 : 0}%`;
            
            saveCurrentState();
        }

        function saveCurrentState() {
            const data = {
                reps: [...dom.tbody.querySelectorAll(".reps")].map(i => i.value),
                weight: [...dom.tbody.querySelectorAll(".weight")].map(i => i.value),
                previousWeek: dom.previousWeekInput.value,
                sessionIndex: state.currentSessionIndex,
                customSessions: state.sessions,
                workoutStartTime: state.workoutStartTime
            };
            localStorage.setItem('inProgressWorkout', JSON.stringify(data));
        }

        function loadCurrentState() {
            const data = JSON.parse(localStorage.getItem('inProgressWorkout'));
            if (!data) return;
            
            if (data.sessionIndex === state.currentSessionIndex) {
                dom.tbody.querySelectorAll(".reps").forEach((input, idx) => input.value = data.reps[idx] || '');
                dom.tbody.querySelectorAll(".weight").forEach((input, idx) => input.value = data.weight[idx] || '');
                dom.previousWeekInput.value = data.previousWeek || "";
            }
            if (data.workoutStartTime && !state.workoutStartTime) {
                state.workoutStartTime = data.workoutStartTime;
                startTotalWorkoutTimer();
            }
            updateAllTotals();
        }

        function resetSession() {
            if (confirm("Réinitialiser la séance ? Les données non sauvegardées seront perdues.")) {
                Object.values(state.timers).forEach(timer => clearInterval(timer.interval));
                state.timers = {};
                if (state.totalWorkoutTimeInterval) {
                    clearInterval(state.totalWorkoutTimeInterval);
                    state.totalWorkoutTimeInterval = null;
                }
                state.workoutStartTime = null;
                localStorage.removeItem('inProgressWorkout');
                
                createTable();
                dom.totalTimeEl.textContent = "00:00:00";
                dom.totalTonnageEl.textContent = "0";
                dom.deltaEl.textContent = "0";
                dom.previousWeekInput.value = "";
                showNotification("Séance réinitialisée.", "info");
            }
        }
        
        function finishAndSaveSession() {
            const totalTonnage = +dom.totalTonnageEl.textContent;
            if (totalTonnage === 0) {
                showNotification("Aucune donnée à sauvegarder. Réinitialisation.", "info");
                resetSession();
                return;
            }

            const workoutData = {
                id: Date.now(),
                date: new Date().toISOString(),
                sessionName: dom.sessionSelect.selectedOptions[0].text,
                totalTonnage,
                duration: dom.totalTimeEl.textContent,
                exercises: (state.sessions[state.currentSessionIndex] || []).map((ex, idx) => ({
                    name: ex.name,
                    series: Array.from({length: 5}, (_, i) => ({
                        reps: +dom.tbody.querySelector(`.reps[data-ex='${idx}'][data-serie='${i}']`)?.value || 0,
                        weight: +dom.tbody.querySelector(`.weight[data-ex='${idx}'][data-serie='${i}']`)?.value || 0
                    })).filter(s => s.reps > 0 && s.weight > 0)
                })).filter(ex => ex.series.length > 0)
            };
            const history = getHistory();
            history.push(workoutData);
            localStorage.setItem('workoutHistory', JSON.stringify(history));
            showNotification("Séance sauvegardée dans l'historique!", "success");
            resetSession();
        }

        function getHistory() { return JSON.parse(localStorage.getItem('workoutHistory')) || []; }
        
        function displayHistory() {
            dom.historyList.innerHTML = '';
            getHistory().sort((a, b) => b.id - a.id).forEach(session => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div>
                        ${new Date(session.date).toLocaleDateString('fr-FR')} - 
                        <strong>${session.sessionName}</strong> (${session.totalTonnage} kg)
                        ${session.duration ? ` - ⏱️ ${session.duration}` : ''}
                    </div>
                    <div>
                        <button class="btn btn-primary" data-history-action="details" data-history-id="${session.id}">Détails</button>
                        <button class="btn btn-danger" data-history-action="delete" data-history-id="${session.id}">Suppr.</button>
                    </div>
                    <div class="history-details" id="details-${session.id}"></div>`;
                dom.historyList.appendChild(item);
            });
        }
        
        function showHistoryDetails(id) {
            const detailsDiv = document.getElementById(`details-${id}`);
            detailsDiv.classList.toggle('visible');

            if (detailsDiv.classList.contains('visible')) {
                const session = getHistory().find(s => s.id === id);
                if (session) {
                    let detailsHtml = '<h4>Détails des exercices:</h4><ul>';
                    session.exercises.forEach(ex => {
                        detailsHtml += `<li><strong>${ex.name}</strong>: `;
                        ex.series.forEach((s, idx) => {
                             const oneRM = calculate1RM(s.weight, s.reps).toFixed(1);
                             detailsHtml += `S${idx + 1}: ${s.reps} reps @ ${s.weight} kg (1RM: ${oneRM}kg); `;
                        });
                        detailsHtml += '</li>';
                    });
                    detailsHtml += '</ul>';
                    detailsDiv.innerHTML = detailsHtml;
                }
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        function exportCSV() {
            let csv = "Exercice;Serie;Reps;Poids\n";
            (state.sessions[state.currentSessionIndex] || []).forEach((ex, idx) => {
                for(let i = 0; i < 5; i++) {
                    const reps = +dom.tbody.querySelector(`.reps[data-ex='${idx}'][data-serie='${i}']`)?.value || 0;
                    const weight = +dom.tbody.querySelector(`.weight[data-ex='${idx}'][data-serie='${i}']`)?.value || 0;
                    if (reps > 0 && weight > 0) csv += `"${ex.name}";${i+1};${reps};${weight}\n`;
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `seance_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
            showNotification("Export CSV réussi !", "success");
        }
        
        // --- UTILITY & UI FUNCTIONS ---
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            dom.notificationContainer.appendChild(notification);
            void notification.offsetWidth;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove(), { once: true });
            }, duration);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }
        
        function formatTimerDisplay(seconds) {
             const m = Math.floor(seconds / 60);
             const s = Math.floor(seconds % 60);
             return `${m}:${String(s).padStart(2, '0')}`;
        }

        function updateTotalTimeDisplay() {
            if (!state.workoutStartTime) {
                dom.totalTimeEl.textContent = "00:00:00";
                return;
            }
            const elapsedMilliseconds = Date.now() - new Date(state.workoutStartTime).getTime();
            dom.totalTimeEl.textContent = formatTime(elapsedMilliseconds / 1000);
        }

        function startTotalWorkoutTimer() {
            if (!state.totalWorkoutTimeInterval) {
                state.totalWorkoutTimeInterval = setInterval(updateTotalTimeDisplay, 1000);
            }
        }
        
        function applyTheme(theme) {
            if (theme === 'dark') {
                dom.body.classList.add('dark-mode');
                dom.themeToggleBtn.textContent = '☀️';
            } else {
                dom.body.classList.remove('dark-mode');
                dom.themeToggleBtn.textContent = '🌙';
            }
        }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            dom.sessionSelect.addEventListener('change', () => {
                const lastSavedIndex = state.currentSessionIndex;
                if (localStorage.getItem('inProgressWorkout')) {
                    if (!confirm("Changer de séance annulera la séance en cours. Continuer ?")) {
                        dom.sessionSelect.value = lastSavedIndex;
                        return;
                    }
                }
                state.currentSessionIndex = +dom.sessionSelect.value;
                resetSession(); 
            });
            document.getElementById('addExerciseBtn').addEventListener('click', () => {
                const name = dom.customExerciseInput.value.trim();
                if (name) {
                    state.sessions[state.currentSessionIndex].push({ name, rest: "1 min" });
                    createTable();
                    dom.customExerciseInput.value = '';
                    showNotification(`Exercice "${name}" ajouté.`, "info");
                } else {
                    showNotification("Veuillez entrer un nom d'exercice.", "error");
                }
            });

            dom.tbody.addEventListener('change', e => {
                if (e.target.classList.contains('reps') || e.target.classList.contains('weight')) {
                    if (!state.workoutStartTime) {
                        state.workoutStartTime = new Date().toISOString();
                        startTotalWorkoutTimer();
                    }
                    
                    // Pre-fill next weight
                    const exIndex = e.target.dataset.ex;
                    const serieIndex = parseInt(e.target.dataset.serie, 10);
                    
                    const repsInput = dom.tbody.querySelector(`.reps[data-ex='${exIndex}'][data-serie='${serieIndex}']`);
                    const weightInput = dom.tbody.querySelector(`.weight[data-ex='${exIndex}'][data-serie='${serieIndex}']`);
                    
                    if (repsInput.value > 0 && weightInput.value > 0 && serieIndex < 4) {
                        const nextWeightInput = dom.tbody.querySelector(`.weight[data-ex='${exIndex}'][data-serie='${serieIndex + 1}']`);
                        if (nextWeightInput && !nextWeightInput.value) {
                            nextWeightInput.value = weightInput.value;
                        }
                    }

                    updateAllTotals();
                }
            });

            dom.tbody.addEventListener('click', handleTableActions);
            document.getElementById('finishSessionBtn').addEventListener('click', finishAndSaveSession);
            document.getElementById('resetSessionBtn').addEventListener('click', resetSession);
            document.getElementById('viewHistoryBtn').addEventListener('click', () => {
                displayHistory();
                dom.historyModal.classList.remove('hidden');
            });
            dom.historyModal.addEventListener('click', handleHistoryActions);
            document.getElementById('exportBtn').addEventListener('click', exportCSV);
            document.getElementById('importBtn').addEventListener('click', () => dom.importFileInput.click());
            dom.importFileInput.addEventListener('change', () => { /* Import logic removed for brevity */ });
            document.getElementById('closeHistoryModal').addEventListener('click', () => dom.historyModal.classList.add('hidden'));
            dom.themeToggleBtn.addEventListener('click', () => {
                const newTheme = dom.body.classList.contains('dark-mode') ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            document.addEventListener('keydown', e => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 's') { e.preventDefault(); finishAndSaveSession(); }
                    if (e.key === 'e') { e.preventDefault(); exportCSV(); }
                }
                if (e.key === 'Escape' && !dom.historyModal.classList.contains('hidden')) {
                    dom.historyModal.classList.add('hidden');
                }
            });
        }
        
        function handleTableActions(e) {
            const button = e.target.closest('button');
            if (!button) return;
            const row = button.closest('.exercise-row');
            const idx = +row.dataset.exerciseIndex;
            const timerAction = button.dataset.timerAction;
            const action = button.dataset.action;
            if (timerAction) handleTimerActions(timerAction, idx, row);
            else if (action === 'remove') {
                if (confirm(`Supprimer "${state.sessions[state.currentSessionIndex][idx].name}" ?`)) {
                    state.sessions[state.currentSessionIndex].splice(idx, 1);
                    if (state.timers[idx]) {
                        clearInterval(state.timers[idx].interval);
                        delete state.timers[idx];
                    }
                    createTable();
                    showNotification(`Exercice supprimé.`, "info");
                }
            }
        }
        
        function handleTimerActions(timerAction, idx, row) {
             const timerDisplay = row.querySelector('.timer-display');
             const restString = state.sessions[state.currentSessionIndex][idx].rest;
            let restSeconds = parseInt(restString) * (restString.includes('min') ? 60 : 1) || 60;
            const duration = Math.max(restSeconds, 60);

            if (timerAction === 'start') {
                if (state.timers[idx] && state.timers[idx].interval) clearInterval(state.timers[idx].interval);
                state.timers[idx] = {
                    secondsElapsed: 0,
                    duration: duration,
                    interval: setInterval(() => {
                        state.timers[idx].secondsElapsed++;
                        const remaining = state.timers[idx].duration - state.timers[idx].secondsElapsed;
                        if (remaining <= 0) {
                            timerDisplay.textContent = "0:00";
                            timerDisplay.classList.remove('timer-active');
                            clearInterval(state.timers[idx].interval);
                            showNotification(`Repos terminé pour ${state.sessions[state.currentSessionIndex][idx].name}!`, "info");
                            row.querySelector('[data-timer-action="start"]').classList.remove('hidden');
                            row.querySelector('[data-timer-action="stop"]').classList.add('hidden');
                        } else {
                            timerDisplay.textContent = formatTimerDisplay(remaining);
                        }
                    }, 1000)
                };
                timerDisplay.textContent = formatTimerDisplay(duration);
                timerDisplay.classList.add('timer-active');
                row.querySelector('[data-timer-action="start"]').classList.add('hidden');
                row.querySelector('[data-timer-action="stop"]').classList.remove('hidden');

            } else if (timerAction === 'stop' || timerAction === 'reset') {
                if (state.timers[idx] && state.timers[idx].interval) clearInterval(state.timers[idx].interval);
                state.timers[idx] = null;
                timerDisplay.classList.remove('timer-active');
                timerDisplay.textContent = formatTimerDisplay(duration);
                row.querySelector('[data-timer-action="start"]').classList.remove('hidden');
                row.querySelector('[data-timer-action="stop"]').classList.add('hidden');
            }
        }

        function handleHistoryActions(e) {
            const button = e.target.closest('button');
            if (!button) return;
            const historyAction = button.dataset.historyAction;
            const historyId = +button.dataset.historyId;
            if (historyAction === 'details') showHistoryDetails(historyId);
            else if (historyAction === 'delete') deleteHistoryItem(historyId);
        }

        function deleteHistoryItem(id) {
            if (confirm("Voulez-vous vraiment supprimer cette séance de l'historique ?")) {
                let history = getHistory().filter(session => session.id !== id);
                localStorage.setItem('workoutHistory', JSON.stringify(history));
                displayHistory();
                showNotification("Séance supprimée de l'historique.", "info");
            }
        }

        // --- INITIALIZATION ---
        function init() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            const inProgress = JSON.parse(localStorage.getItem('inProgressWorkout'));
            if (inProgress?.customSessions) {
                state.sessions = inProgress.customSessions;
                state.currentSessionIndex = inProgress.sessionIndex || 0;
                state.workoutStartTime = inProgress.workoutStartTime || null;
            } else {
                state.sessions = JSON.parse(JSON.stringify(defaultSessions));
            }
            dom.sessionSelect.value = state.currentSessionIndex;
            
            setupEventListeners();
            createTable();
            if (state.workoutStartTime) {
                startTotalWorkoutTimer();
            }
        }

        init();
    });
    </script>
</body>
</html>